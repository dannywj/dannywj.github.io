---
title: 盛夏开发那点事儿
tags: [develop,work]
date: 2016-07-25 11:28:30
---
# 心静也不凉
话说今年北京的天气真是罕见的热，闷热+暴雨交织着，让原本浮躁的心更加的躁动，但是总结依旧要坚持，只有这样，才能让点滴的积累拥有质变。

最近接手了个性化清单的需求，十分复杂，开发完成之际，回顾一下，也有些滋味。

# 需求方面
## 需求的把控
说不通的逻辑（复杂逻辑）一定是不合理的。清洗的逻辑一定简单明了，需要进行逻辑的梳理和简化。

这部分不仅需要产品经理来简化，更需要开发人员进行一定的思考和总结，提供给产品经理一系列的意见和建议。

A.产品形态上的（如别家的做法是xx的）
B.技术层面的（某种功能如果实现会严重影响性能，会无法实现分页等）

## 产品分析的时候要考虑是否对性能有影响
1. 考虑分页加载的事宜（实现和难易度）
1. 考虑加载性能问题（尤其是首页）
1. 对于开发资源未给出会影响开发进度的情况，要提出，由项目经理跟进，催促，不要因此影响开发进度。

# 开发的构思和设计
## 基本设计理念
1. 大的接口逻辑可以考虑进行拆分，否则逻辑过于复杂，难以维护。
1. DB设计 重复的子主题可以考虑使用关联列的形式实现。（增加int型关联字段，主表和明细表用此字段进行关联）
1. 后台与前台的设计要统一，否则容易出问题（周，月的划分）
1. 历史记录的清除机制需要考虑，否则随着时间增长会越来越多，一定要有清除的机制和触发点。
1. 循环操作要警惕！里面有curl等耗时操作一定要禁止，想其他办法提前获取到资源。
1. 资源信息获取前置，如图片宽高信息。
1. 老数据是做数据清洗还是逻辑控制？数据清洗有成本，脚本+旧入口关闭。程序中转换控制相对成本较小，且易于操作。

## 关于面向对象
- [ ] 尝试使用面向对象方式+设计模式进行功能的设计，尤其是大的功能模块，有利于扩展和维护。自定义类参考：[CI文档——创建类库](http://codeigniter.org.cn/user_guide/general/creating_libraries.html)
- [ ] 私有成员如包含CI框架，var_dump类成员的时候会打印出来好多CI的属性，可以尝试在内部实例化。
```php
 /**
     * 设置主题详情 read from DB
     * @return mixed
     */
    public function setContentInfo() {
        $CI = &get_instance();
        $CI->load->model('listing_model', 'mListing');
        $result = $CI->mListing->getThemeContent($this->_relate_flag);
        $CI->load->library('special/themecontent');

        if (is_array($result)) {
            $count = 0;
            foreach ($result as $item) {
                if ($count >= 3) {
                    break;
                }
                $content = new ThemeContent();
                $content->setId($item['id']);
                $content->setContentTitle($item['content_title']);
                $content->setCoverPic($item['cover_pic'], $item['pic_w'], $item['pic_h']);
                $content->setTargetUrl($item['target_url']);
                $content->setSource($item['source']);
                $this->_content_info[] = $content;
                $count++;
            }
        }
    }
```

- [ ] 上述情景如果类对象内需要多处使用CI内置对象，可以采用**变通**的方式来进行。
```php
    // 对象类内部定义私有属性CI，并在构造函数中初始化
    private $_CI;
    public function __construct() {
       $this->_CI=&get_instance();
    }

    // 添加一个公共方法，移除CI对象
    public function unsetCI() {
       unset($this->_CI);
    }

    ////////////////////

    // 调用方自定义打印函数
    function var_dump_obj($obj) {
        if (method_exists($obj, 'unsetCI')) {
            $obj->unsetCI();
        }
        var_dump($obj);
    }
    // 调用
    $a = array('key' => 'test');
    $this->var_dump_obj($a);
    $this->var_dump_obj($theme);
```
- [ ] 没有完全的面向对象
在进行类的划分过程中，由于涉及文件较多，本次没有完全将各个主体进行单独类的定义，还是出现了部分if else的情况（swich case），继承的实现没有更好的理解。
本次仅仅是尝试着在CI框架中引入自定义类来进行的。

# 代码实现说明
## 基本说明
### controller
入口，参数验证，业务逻辑处理，类方法调用，结果汇总，输出

### class
模型定义，自身方法实现

### model
DB数据获取

```php
/**
 * 场景主题类
 * Created by DannyWang
 * wangjue@mia.com
 * 2016/7/14
 */
class Theme {
    private $_id;
    private $_title;
    private $_subtitle;
    private $_icon;
    private $_type;
    private $_relate_flag;
    private $_match_age;
    private $_age_start;
    private $_age_end;
    private $_content_info = array();

    const SCENE_TYPE_BIRTHDAY = 0;
    const SCENE_TYPE_SPECIAL = 1;
    const SCENE_TYPE_NORMAL = 2;
    const SCENE_TYPE_BORN = 3;

    public function __construct() {
    }

    /**
     * @return mixed
     */
    public function getId() {
        return $this->_id;
    }

    /**
     * @param mixed $id
     */
    public function setId($id) {
        $this->_id = $id;
    }

    /**
     * @return mixed
     */
    public function getTitle() {
        return $this->_title;
    }

    /**
     * @param mixed $title
     */
    public function setTitle($title) {
        $this->_title = $title;
    }

    /**
     * @return mixed
     */
    public function getSubtitle() {
        return $this->_subtitle;
    }

    /**
     * @param mixed $subtitle
     */
    public function setSubtitle($subtitle) {
        $this->_subtitle = $subtitle;
    }

    /**
     * @return mixed
     */
    public function getIcon() {
        return $this->_icon;
    }

    /**
     * @param mixed $icon
     */
    public function setIcon($icon) {
        $this->_icon = IMAGE_URL . $icon;
    }

    /**
     * @return mixed
     */
    public function getType() {
        return $this->_type;
    }

    /**
     * @param mixed $type
     */
    public function setType($type) {
        $this->_type = $type;
    }

    /**
     * @return mixed
     */
    public function getMatchAge() {
        return $this->_match_age;
    }

    /**
     * @param mixed $match_age
     */
    public function setMatchAge($match_age) {
        $this->_match_age = $match_age;
    }

    /**
     * @return mixed
     */
    public function getAgeStart() {
        return $this->_age_start;
    }

    /**
     * @param mixed $age_start
     */
    public function setAgeStart($age_start) {
        $this->_age_start = $age_start;
    }

    /**
     * @return mixed
     */
    public function getAgeEnd() {
        return $this->_age_end;
    }

    /**
     * @param mixed $age_end
     */
    public function setAgeEnd($age_end) {
        $this->_age_end = $age_end;
    }

    /**
     * 设置主题详情 read from DB
     * @return mixed
     */
    public function setContentInfo() {
        $CI = &get_instance();
        $CI->load->model('listing_model', 'mListing');
        $result = $CI->mListing->getThemeContent($this->_relate_flag);
        $CI->load->library('special/themecontent');

        if (is_array($result)) {
            $count = 0;
            foreach ($result as $item) {
                if ($count >= 3) {
                    break;
                }
                $content = new ThemeContent();
                $content->setId($item['id']);
                $content->setContentTitle($item['content_title']);
                $content->setCoverPic($item['cover_pic'], $item['pic_w'], $item['pic_h']);
                $content->setTargetUrl($item['target_url']);
                $content->setSource($item['source']);
                $this->_content_info[] = $content;
                $count++;
            }
        }
    }

    /**
     * 添加主题内容项
     * @param $content_obj
     */
    public function addContentItem($content_obj) {
        $this->_content_info[] = $content_obj;
    }


    /**
     * @return mixed
     */
    public function getRelateFlag() {
        return $this->_relate_flag;
    }

    /**
     * @param mixed $relate_flag
     */
    public function setRelateFlag($relate_flag) {
        $this->_relate_flag = $relate_flag;
    }

    /**
     * 返回格式化数组
     * @return array
     */
    public function toArray() {
        $content_info_arr = array();
        if ($this->_content_info) {
            foreach ($this->_content_info as $item) {
                $content_info_arr[] = $item->toArray();
            }
        }
        return array(
            'id' => $this->_id,
            'title' => $this->_title,
            'subtitle' => $this->_subtitle,
            'icon' => $this->_icon,
            'type' => $this->_type,
            'detail_info' => $content_info_arr,
        );
    }

}
```



```php
/**
 * 场景主题内容类
 * Created by DannyWang
 * wangjue@mia.com
 * 2016/7/14
 */
class ThemeContent {
    private $_id;
    private $_content_title;
    private $_cover_pic;
    private $_target_url;
    private $_source;

    public function __construct() {
    }

    /**
     * @return mixed
     */
    public function getId() {
        return $this->_id;
    }

    /**
     * @param mixed $id
     */
    public function setId($id) {
        $this->_id = $id;
    }

    /**
     * @return mixed
     */
    public function getContentTitle() {
        return $this->_content_title;
    }

    /**
     * @param mixed $content_title
     */
    public function setContentTitle($content_title) {
        $this->_content_title = $content_title;
    }

    /**
     * @return mixed
     */
    public function getCoverPic() {
        return $this->_cover_pic;
    }

    /**
     * @param mixed $cover_pic
     */
    public function setCoverPic($cover_pic, $pic_w, $pic_h) {
        $this->_cover_pic = array(
            'url' => IMAGE_URL . $cover_pic,
            'width' => $pic_w,
            'height' => $pic_h,
        );
    }

    /**
     * @return mixed
     */
    public function getTargetUrl() {
        return $this->_target_url;
    }

    /**
     * @param mixed $target_url
     */
    public function setTargetUrl($target_url) {
        $this->_target_url = $target_url;
    }

    /**
     * @return mixed
     */
    public function getSource() {
        return $this->_source;
    }

    /**
     * @param mixed $source
     */
    public function setSource($source) {
        $this->_source = $source;
    }

    /**
     * 返回格式化数组
     * @return array
     */
    public function toArray() {
        return array(
            'id' => $this->_id,
            'content_title' => $this->_content_title,
            'cover_pic' => $this->_cover_pic,
            'target_url' => $this->_target_url,
            'source' => $this->_source,
        );
    }
}
```



```php
/**
 * 简单场景主题类
 * Created by DannyWang
 * wangjue@mia.com
 * 2016/7/14
 */
class SimpleTheme {
    private $_status_info;
    private $_pic_info;
    private $_target_url;

    /**
     * SimpleTheme constructor.
     */
    public function __construct() {

    }

    /**
     * @return mixed
     */
    public function getStatusInfo() {
        return $this->_status_info;
    }

    /**
     * @return mixed
     */
    public function getPicInfo() {
        return $this->_pic_info;
    }

    /**
     * @return mixed
     */
    public function getTargetUrl() {
        return $this->_target_url;
    }

    /**
     * 根据类型设置简单场景信息
     * @param $type
     * @return bool
     */
    public function setSimpleThemeByStatus($listing_status) {
        $CI = &get_instance();
        $CI->config->load("listing_config");
        $result = $CI->config->item('simple_theme');
        if (isset($result[$listing_status])) {
            $this->_status_info = $result[$listing_status]['rec_title'];
            $this->_pic_info = IMAGE_URL . $result[$listing_status]['rec_pic'];
            $this->_target_url = $result[$listing_status]['target_url'];
            return true;
        } else {
            return false;
        }
    }
}
```
# 业务流程
 ![业务流程图](https://raw.githubusercontent.com/dannywj/dannywj.github.io/raw/raw/source/statics/special.jpg)

# 好的需求文档
1. 一定有背景说明，否则需求熟悉和理解阶段很难进入。
2. 更新后增加修改历史或修改的文字高亮。
3. 每次开会后将修改的信息及时反映在文档中，开会时需文字记录。

# 需要注意的点
1. 数据获取时间临界值的判断，最好加上=（<=） date判断
2. visio流程图工具输出打印尺寸（导出JPG时）

# 需要改进
## 组内沟通
1. 公共方法的实现（如涉及同一个模块）
1. 命名的统一，DB/API/文档的命名要一致，英文名称要斟酌。

## 技术实现
1. 对于面向对象继承的理解不够深入，不同的主题应该是继承基类并分别实现自己不同的方法才是更理想的设计方式。
1. controller和model的比重问题值得商榷，但是理想的方式的均比较轻量级，具体实现放入类中。可以考虑在library中**增加一个业务逻辑类BusinessClass**，controller中只做参数验证和BusinessClass类的调用及结果输出。model中主要做DB的CURD操作。**BusinessClass中包含业务逻辑及对model中方法的调用**。
1. 自定义类中对属性有多个set()方法，可以考虑使用**链式调用**方式优雅的实现。具体参考《PHP对象方法链式调用》一文。