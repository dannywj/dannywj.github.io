---
title: 左连接数据结果增多是怎么回事
tags: develop
date: 2016-01-27 16:35:47
---

# 背景描述
两张数据表，一张是我们自己的业务订单，另一个是第三方服务商的订单流水。两个数据表有一个对应的序列号sn列（关联列）。

**需求：** 以第三方服务商的订单流水为基准，查询出对应我们自己订单的厂商类型等信息。
# 问题SQL
**第一次解决方法：**使用左连接+like 方式查询
**结果：**

1. 耗时严重，几千条数据查询了好几分钟。
2. 结果有误，结果比第三方原始表多出了一些数据。（使用左连接）

SQL：
```SQL
SELECT  *
FROM third_party_order b 
LEFT JOIN dict_transaction a
on a.data like CONCAT( '%' , b.sn , '%')
```
# 原理分析
**问题原因：**
a表中的某些记录在b表中有1对多的关系，就会出现left join后记录数多于原始的情况。

**改进建议：**
使用left join的两个表，最好是1:1 或 1:0的关系，这样可以保证A表的记录全部显示，B表显示符合条件的记录。
如果B表符合条件的记录不唯一，因此这种情况**需要保证B表的符合条件的记录是空或唯一**，我们可以使用`group by`来实现。


# 改进方案
1. 使用程序将data（JSON）数据进行匹配，将关联列单独拆分出来，更新到新的一列中。（明显增加查询速度）

2. 对left join的右表进行`去重`后再进行左连接查询，即可保证查询的结果数和原始表相同。

SQL:
```SQL
SELECT  *
FROM third_party_order b 
LEFT JOIN (select sn, max(apikeyid) as apikeyid ,max(id) as dhb_transaction_id from dict_transaction group by sn ) a
on a.sn=b.sn
```

# 思考
SQL不是万能的，有时候需要用程序结合SQL的方式处理日常小任务。简单！高效！