---
title: 会员体系那点事
tags: [develop,work]
date: 2016-08-26 17:10:46
---
# 思想与感受

## 需求分析该想啥
1. 版本需求中是否有重大改动，包括数据计算机制，规则等，是否会对旧版有影响。
1. 是否需要强制升级？不强制升级的话，如何做兼容处理，工作量多大？
1. 重大改动造成版本不一致的情况，需要产品文字说明（邮件），防止后期出现问题无法追溯。
1. 需求中需要的数据，前期应该考虑一下计算方式，是否容易获取，是否满足性能要求。如超越xx%的用户。
1. 分页及排序的可能性考虑（第三方接口中也要考虑分页和排序的支持）
1. 缓存及非实时数据提前告知。非核心数据允许一段时间的数据不同步，但是需要提前告知产品和测试。调用方不用做缓存清除机制。


## 行动起来怎么做
### 对接提前
涉及和第三方对接的地方要提前考虑，必须先行。包括但不限于：需求告知，协议制定，分页及排序要求，demo规范等，不能让排期让不可控制的因素占据。

### 适当冗余
优惠券兑换表为防止查询API获取优惠券信息，可以在存储的时候进行适当的冗余字段存储，方便查询。（需提前约定好优惠券信息创建后不可改变）

### 服务化封装原则
第三方封装的接口，使用者不要直接读表，进行关联查询和排序等，如有需求，需要让接口提供方提供此类查询接口，保证服务化的封装性。

### 本地封装API
第三方API提供到位后，本地应该进行适当的封装和简化。

### 向前兼容
谨慎修改原接口字段的返回值，如用户信息。

# 代码怎么写
## 代码结构设计
```
├─application
│  ├─config
│  │  ├─member_config.php                   会员体系配置文件
│  │  └─mirsrv.php                          服务化API配置文件
│  ├─controller
│  │  ├─android
│  │  │  └─member.php                       安卓控制器
│  │  └─ios
│  │     └─member.php                       IOS控制器
│  ├─library
│  │  ├─member                              会员体系核心类库
│  │  │  ├─service_sdk                      蜜豆，蜜粉API类库
│  │  │  ├─Business.php                     会员体系业务逻辑处理类
│  │  │  ├─ContextBlock.php                 内容模块类
│  │  │  ├─CouponItem.php                   优惠券单品类
│  │  │  ├─DiaryTemplate.php                日记模板类
│  │  │  ├─IContextBlock.php                内容模块接口
│  │  │  ├─IntroductionTemplate.php         简介模板类
│  │  │  ├─LevelToast.php                   等级弹层类
│  │  │  ├─MemberDayTemplate.php            会员日模板类
│  │  │  ├─MibeanCoupon.php                 蜜豆优惠券类
│  │  │  ├─MiBeanService.php                蜜豆服务API封装
│  │  │  ├─MiScoreService.php               蜜粉服务API封装
│  │  │  ├─TargetUrl.php                    目标链接类
│  │  │  ├─TaskTemplate.php                 任务模板类
│  │  │  ├─Template.php                     会员模板基类
│  │  │  └─Toast.php                        会员弹层基类
│  │  └─coupon_service.php                  优惠券API封装
│  └─models
│     └─member_model.php                    数据访问层model

```
## 匿名对象
```php
$diary_template->setTitle('蜜芽日记')
            ->setContextBlock([
                    (new ContextBlock())->setPic($template_config['mia_diary'])->setTargetUrl((new TargetUrl($template_url_config['mia_diary'], TargetUrl::TYPE_NORMAL_URL)))->toArray(),
                ]
            );
```

## 链式调用
```php
$member_day_template->setTitle('会员日')->setSubTitle('专享大礼、会员特价')
```
