---
title: 精准投放市场对接流程
tags: [develop,work]
date: 2016-04-08 15:26:25
---
# 功能及背景概述
通过第三方广告平台投放的下载链接，引导用户进行APP的下载，激活，注册等过程，通过与第三方接口对接的形式来统计相关转化率。

# 名词解释
激活——用户首次打开APP的行为
注册——用户使用手机号等方式注册完成后的行为

# 业务流程图
 ![业务流程图](https://raw.githubusercontent.com/dannywj/dannywj.github.io/master/statics/CPA_flow.png)
# 业务流程补充说明
原则上，第三方广告方要求用户激活成功后“实时”将信息上报给第三方，但是考虑到接口性能方面，对于上报的处理目前分为两种情况：

**1.实时上报，不关心上报结果。**
此种情况是在用户点击广告的时候，广告方以接口的形式将需要上报的完整url回调通知我们，我们在用户激活完成后，实时发起curl请求，并设置反馈成功状态。
*cpas_model.php*
```php
if ($inserId && $actionInfo['platform_id'] == 7 && $actionInfo['click_info'] != '') {
      $callbackUrl = urldecode($actionInfo['click_info']);
      curl_get($callbackUrl);
      $this->setPuthed(array($inserId));
}
```
**2.准实时上报**
由计划任务每40分钟执行一次，将之前本渠道未上报的数据集中上报，并设置反馈状态。
如：`http://api.miyabaobei.com/cpa/pushWechatMP`

# 开发流程
1.熟悉市场需求，建立相关人员讨论组，获取第三方对接文档及第三方广告平台配置账号。
2.搭建（获取）外网能访问的测试环境，如http://api-test.miyabaobei.com。
3.增加新市场渠道配置字段。
4.配置第三方回调地址，准备联调。
5.根据业务流程，开发接收第三方数据接口，并自测，联调通过。（可以参考之前receiveXXX的方法模式）。
6.根据业务流程，开发上报接口，并自测，联调通过。（可以参考之前pushXXX的方法模式）。
7.与BI组同学对接，确认统计关键字，并在配置文件中增加配置字段。
8.接口上线，修改第三方回调地址，重新联调。
9.通知市场同学上线完成，并由市场同学配置相应广告入口。
10.观察最近广告入口的点击数据是否正常，手动执行上报脚本，观察返回值及DB中的相应状态是否成功更新。
11.与BI组同学确认新添加的渠道是否能正常统计到数据。
12.与第三方技术/产品同学确认是否收到上报数据。
13.配置上报脚本到计划任务中，继续观察一段时间。


# 相关表,控制器及方法说明
## 数据表
cpa_platforms 广告商配置表
cpa_action_lists 广告点击记录表
cpa_platform_activation_lists 广告商激活记录表（is_push_to_cpa=2为上报成功，user_id有值为已注册）
ios_activation_logs IOS激活日志表


## 控制器及方法
**1.接收**
接收第三方点击传的数据
/api/application/controller/cpa.php  receive方法
**2.激活**
根据设备token ,判断是否是第一次激活, 第一次激活通过规则判断是来自哪家广告商的,记录platform_id,然后写入激活表
/api/application/controller/ios/4_0/index.php 的activation方法
**3.上报**
根据激活信息定期推送至第三方
/api/application/controller/cpa.php  push方法
**4.注册(转化)**
用户注册时会通过规则判断是哪家广告商的，然后在激活表记录user_id，便于统计转化
/api/application/controller/ios/4_0/account.php register方法

* * *

# 特别说明
市场对接目前仅涉及IOS相关API，Android由于有自己的Android Package管理策略，不在开发范围之内。


# 上线注意事项
确认线上环境数据库中的==platform_id==是否和代码中的一致。

# 后续流程
上线完毕后，需要和BI组同学一起确认新添加的渠道在统计后台是否成功显示。

# 其他说明
1.由于原有逻辑在接收muid的时候有可能会拼接mac，在只有唯一的muid的情况下，也需要拼接'|',便于激活时匹配。

2.测试环境的渠道号有可能和线上不一致，上线前需要确认并修改代码中的渠道号（cpa_platforms表）。

3.为便于开发调试，在cpa中增加了记录日志的方法，可以在日志中查看对方回调的相关参数
使用方法：`$this->logInfo('info'),`
日志记录在`/opt/logs/api/wechat_all_xxxxx.log`

4.线上验证成功后，记得添加计划任务到线上。
