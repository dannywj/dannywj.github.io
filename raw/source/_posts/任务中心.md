---
title: 任务中心系统设计
tags: [develop,work]
date: 2017-10-31 16:52:15
---
# 业务说明

APP中不同业务模块的功能整合到任务中心的统一入口中，方便新用户完成各项任务并获得奖励。
每个任务完成的同时会获得自身的奖励，同时，累计的任务完成数达到目标后，还可以获得开启宝箱的资格，通过开启宝箱，还可以获得更多的奖励。


# 架构体系

## 概述
任务中心是各个业务模块完成自身任务后，汇总给任务中心服务端，进行统一的任务记录，奖励发放等逻辑。
采用消息队列机制，各个业务方按照约定的消息格式向任务中心MQ发送消息，告知用户的任务完成情况。

## 架构示意图
![](https://raw.githubusercontent.com/dannywj/dannywj.github.io/raw/raw/source/statics/task.png)

## 任务类型

| 任务id | 任务名称 |完成奖励|业务方|业务方处理奖励|
|--------|--------|--------|--------|--------|
|   1     |  完善宝宝信息      |   +10蜜豆    	 |   API     |     N   |
|   2     |  完善地址信息      |   +5蜜豆    	 |   API     |     N   |
|   ……     |  ……      |   ……    	 |   ……     |     ……   |


## 任务通知方式及参数定义

采用RabbitMQ消息队列进行数据交互。

### 数据格式

**json**

### 数据项说明

| 字段名 | 字段类型 |是否必传|字段含义|
|--------|--------|--------|--------|
|   user_id     |  	int |	Y	| 用户id|
|   task_id     |  	int |	Y	| 任务id|
|   is_processed     |  	bool |	Y	| 是否已处理奖励|
|   reward_name     |  	string |	N	| 已发放奖励名称。is_processed 为true时必传|
|   finished_time     |  	string |	Y	| 任务完成时间|


### 示例数据

``` json
{
  "user_id": 10001,
  "task_id": 1,
  "is_processed": true,
  "reward_name": "10蜜豆/每贴",
  "finished_time": "2017-10-13 10:00:04"
}
```



# 设计关键点
考虑到用户比较多，每天的任务完成后数据积累比较多，因此需要分散用户每天的数据，提高查询效率。

目前可采用的方式有如下几个：

1. 数据查询走redis。 key-val形式，使用脚本定期落库（扫描并清理redis中的数据，写入表）
2. 按天分表，新建单独的数据库，每周/月定时建立下周/月的空表。将每天的数据分表保存。
3. 使用一张表，脚本跑之前的数据到历史表中，保证当前表的数据量控制在1天。

综合考虑，目前使用方案2来实现。







# 相关表结构

```sql
CREATE TABLE `task` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `type` int(30) NOT NULL DEFAULT '1' COMMENT '任务类型 1-一次性任务 2-多次可完成任务',
  `name` varchar(255) NOT NULL DEFAULT '' COMMENT '任务名称',
  `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '任务图标',
  `group_type` tinyint(8) NOT NULL DEFAULT '1' COMMENT '任务分组 1-新人任务 2-日常任务 3-蜜芽圈任务',
  `reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '奖励名称',
  `reward_value` varchar(50) NOT NULL DEFAULT '' COMMENT '奖励值',
  `reward_type` tinyint(8) NOT NULL DEFAULT '1' COMMENT '任务奖励类型 1-蜜豆 2-优惠券 3-红包 4-其它',
  `status` tinyint(2) NOT NULL DEFAULT '0' COMMENT '状态 1启用  0 未启用',
  `start_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '开始时间',
  `end_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '结束时间',
  `task_url` varchar(255) NOT NULL DEFAULT '' COMMENT '未完成跳转链接',
  `finished_url` varchar(255) NOT NULL DEFAULT '' COMMENT '已完成跳转链接',
  `task_button_txt` varchar(50) NOT NULL DEFAULT '' COMMENT '任务未完成文案',
  `finished_button_txt` varchar(50) NOT NULL DEFAULT '' COMMENT '已完成文案',
  `sort` int(11) NOT NULL DEFAULT '0' COMMENT '排序(越大越靠前)',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=utf8 COMMENT='任务配置表';





CREATE TABLE `task_final_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '完成任务用户id',
  `task_id` int(11) NOT NULL DEFAULT '0' COMMENT '任务id',
  `processed_reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '已获取的奖励名称（个性化的奖励名称）',
  `finished_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '任务完成时间',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_finished_time` (`finished_time`)
) ENGINE=InnoDB AUTO_INCREMENT=2901927 DEFAULT CHARSET=utf8 COMMENT='一次性任务用户完成日志';




CREATE TABLE `task_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '完成任务用户id',
  `task_id` int(11) NOT NULL DEFAULT '0' COMMENT '任务id',
  `processed_reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '已获取的奖励名称（个性化的奖励名称）',
  `finished_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '任务完成时间',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_finished_time` (`finished_time`)
) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8 COMMENT='用户日常任务完成日志';




CREATE TABLE `task_reward_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增id',
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '用户id',
  `reward_id` int(11) NOT NULL DEFAULT '0' COMMENT '奖励宝箱id',
  `open_date` date NOT NULL DEFAULT '0000-00-00' COMMENT '开宝箱日期',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`),
  KEY `index_user_id_date` (`open_date`,`user_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8 COMMENT='任务奖励日志表';

```