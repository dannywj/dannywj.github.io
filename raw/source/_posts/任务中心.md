---
title: 任务中心系统设计
tags: [develop,work]
date: 2017-10-31 16:52:15
---
# 业务说明

APP中不同业务模块的功能整合到任务中心的统一入口中，方便新用户完成各项任务并获得奖励。
每个任务完成的同时会获得自身的奖励，同时，累计的任务完成数达到目标后，还可以获得开启宝箱的资格，通过开启宝箱，还可以获得更多的奖励。


# 架构体系

## 概述
任务中心是各个业务模块完成自身任务后，汇总给任务中心服务端，进行统一的任务记录，奖励发放等逻辑。
采用消息队列机制，各个业务方按照约定的消息格式向任务中心MQ发送消息，告知用户的任务完成情况。

## 架构示意图
![](https://raw.githubusercontent.com/dannywj/dannywj.github.io/raw/raw/source/statics/task.png)

## 任务类型

| 任务id | 任务名称 |完成奖励|业务方|业务方处理奖励|
|--------|--------|--------|--------|--------|
|   1     |  完善宝宝信息      |   +10蜜豆    	 |   API     |     N   |
|   2     |  完善地址信息      |   +5蜜豆    	 |   API     |     N   |
|   ……     |  ……      |   ……    	 |   ……     |     ……   |


## 任务通知方式及参数定义

采用RabbitMQ消息队列进行数据交互。

### 数据格式

**json**

### 数据项说明

| 字段名 | 字段类型 |是否必传|字段含义|
|--------|--------|--------|--------|
|   user_id     |  	int |	Y	| 用户id|
|   task_id     |  	int |	Y	| 任务id|
|   is_processed     |  	bool |	Y	| 是否已处理奖励|
|   reward_name     |  	string |	N	| 已发放奖励名称。is_processed 为true时必传|
|   finished_time     |  	string |	Y	| 任务完成时间|


### 示例数据

``` json
{
  "user_id": 10001,
  "task_id": 1,
  "is_processed": true,
  "reward_name": "10蜜豆/每贴",
  "finished_time": "2017-10-13 10:00:04"
}
```



# 设计关键点
考虑到用户比较多，每天的任务完成后数据积累比较多，因此需要分散用户每天的数据，提高查询效率。

目前可采用的方式有如下几个：

1. 数据查询走redis。 key-val形式，使用脚本定期落库（扫描并清理redis中的数据，写入表）
2. 按天分表，新建单独的数据库，每周/月定时建立下周/月的空表。将每天的数据分表保存。
3. 使用一张表，脚本跑之前的数据到历史表中，保证当前表的数据量控制在1天。

综合考虑，目前使用方案2来实现。







# 相关表结构

```sql
CREATE TABLE `task` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `type` int(30) NOT NULL DEFAULT '1' COMMENT '任务类型 1-一次性任务 2-多次可完成任务',
  `name` varchar(255) NOT NULL DEFAULT '' COMMENT '任务名称',
  `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '任务图标',
  `group_type` tinyint(8) NOT NULL DEFAULT '1' COMMENT '任务分组 1-新人任务 2-日常任务 3-蜜芽圈任务',
  `reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '奖励名称',
  `reward_value` varchar(50) NOT NULL DEFAULT '' COMMENT '奖励值',
  `reward_type` tinyint(8) NOT NULL DEFAULT '1' COMMENT '任务奖励类型 1-蜜豆 2-优惠券 3-红包 4-其它',
  `status` tinyint(2) NOT NULL DEFAULT '0' COMMENT '状态 1启用  0 未启用',
  `start_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '开始时间',
  `end_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '结束时间',
  `task_url` varchar(255) NOT NULL DEFAULT '' COMMENT '未完成跳转链接',
  `finished_url` varchar(255) NOT NULL DEFAULT '' COMMENT '已完成跳转链接',
  `task_button_txt` varchar(50) NOT NULL DEFAULT '' COMMENT '任务未完成文案',
  `finished_button_txt` varchar(50) NOT NULL DEFAULT '' COMMENT '已完成文案',
  `sort` int(11) NOT NULL DEFAULT '0' COMMENT '排序(越大越靠前)',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=utf8 COMMENT='任务配置表';





CREATE TABLE `task_final_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '完成任务用户id',
  `task_id` int(11) NOT NULL DEFAULT '0' COMMENT '任务id',
  `processed_reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '已获取的奖励名称（个性化的奖励名称）',
  `finished_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '任务完成时间',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_finished_time` (`finished_time`)
) ENGINE=InnoDB AUTO_INCREMENT=2901927 DEFAULT CHARSET=utf8 COMMENT='一次性任务用户完成日志';




CREATE TABLE `task_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '完成任务用户id',
  `task_id` int(11) NOT NULL DEFAULT '0' COMMENT '任务id',
  `processed_reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '已获取的奖励名称（个性化的奖励名称）',
  `finished_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '任务完成时间',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_finished_time` (`finished_time`)
) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8 COMMENT='用户日常任务完成日志';




CREATE TABLE `task_reward_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增id',
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '用户id',
  `reward_id` int(11) NOT NULL DEFAULT '0' COMMENT '奖励宝箱id',
  `open_date` date NOT NULL DEFAULT '0000-00-00' COMMENT '开宝箱日期',
  `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`),
  KEY `index_user_id_date` (`open_date`,`user_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8 COMMENT='任务奖励日志表';

```

# 消息队列配置注意事项

任务中心消耗,由于服务器有多台机器消耗，因此配置的时候分组进行
rabbitMQ 管理后台（15672）需使用VMServer登录，查看，连接配置使用vip进行配置（HA架构）

消耗脚本入口增加参数：nohup sh /opt/webroot/api/current/bin/fork_push.sh /amqp_task_center_process/consume/${j} 1 >/dev/null 2>&1 &

```
$amqp['task_center_consume'] = [
    [
        'host'     => "10.1.52.192",
        'port'     => "5672",
        'login'    => "miya_amqp_admin",
        'password' => "miya_admin_pwd",
        'vhost'    => "/"
    ] ,
    [
        'host'     => "10.1.52.193",
        'port'     => "5672",
        'login'    => "miya_amqp_admin",
        'password' => "miya_admin_pwd",
        'vhost'    => "/"
    ] ,
    [
        'host'     => "10.1.52.194",
        'port'     => "5672",
        'login'    => "miya_amqp_admin",
        'password' => "miya_admin_pwd",
        'vhost'    => "/"
    ] ,
];

```


# 上线及部署
## 上线命令汇总

### crontab配置

```
# 任务中心跑用户地址数据（指定日期夜间执行，11月9日2点1分执行）
1 2 9 11 * /opt/php/bin/php /opt/webroot/api/current/bin/sh.php /crontab/member_task_init/initAddressInfoTask >/dev/null 2>&1

# 任务中心日志表-每月25号1点执行创建下个月的任务日志表
0 1 25 * * /opt/php/bin/php /opt/webroot/api/current/bin/sh.php /crontab/member_task_init/initTaskTableNextMonth

```

### 手工执行脚本

前台方式（脚本执行时间长的不建议）：
/opt/php/bin/php /opt/webroot/api/current/bin/sh.php /crontab/member_task_init/initBabyInfoTask

后台方式：
nohup /opt/php/bin/php /opt/webroot/api/current/bin/sh.php /crontab/member_task_init/initBabyInfoTask >/dev/null 2>&1 &

nohup /opt/php/bin/php /opt/webroot/api/current/bin/sh.php /crontab/member_task_init/initAddressInfoTask >/dev/null 2>&1 &

### 服务器重启队列shell
P.S. 无密码登录模式，需要手工连接登录一次

``` shell
#!/bin/bash
_opt=$1
main () {
        case "${_opt}" in
                start)
                        start
                        ;;
                stop)
                        stop
                        ;;
                restart)
                       restart
                       ;;
                *)
                        usage
                        exit 1
        esac
}

start() {
        printf "Starting Worker Queue...\n"
        ARRAY_IP=(10.1.52.192 10.1.52.193 10.1.52.194)
        # 机器数
        j=0;
        for ip in ${ARRAY_IP[@]};do
                ssh root@$ip "nohup sh /opt/webroot/api/current/bin/fork_push.sh /amqp_task_center_process/consume/${j} 50 >/dev/null 2>&1 &"
                # test
                # nohup sh /opt/webroot/api/current/bin/fork_push.sh /amqp_task_center_process/consume/${j} 1 >/dev/null 2>&1 &
                ((j++));
        done
}

stop () {
    printf "Stoping Worker Queue...\n"
    ARRAY_IP=(10.1.52.192 10.1.52.193 10.1.52.194)
    for ip in ${ARRAY_IP[@]};do
        ssh root@$ip "ps aux|grep '/amqp_task_center_process/'|grep -v grep|awk '{print \"kill -9 \"\$2}'|sh"
        # test
        #  ps aux|grep '/amqp_task_center_process/'|grep -v grep|awk '{print "kill -9 "$2}'|sh

    done
}

restart() {
    printf "Restarting Worker QUEUE...\n"
    stop
    sleep 1
    start
}
usage() {
        echo "Usage: sh $0 <start|stop|restart>"
        echo
        exit 1
}

main
```


# 脚本执行注意事项

由于上线前需要执行一次老用户数据处理，需要将符合条件的老用户跑入新表，数据量为千万级，因此在设计上需要考虑以下几点：

1. 脚本初始化设置够大（内存占用，执行时间）
2. 数据库主从连接确认
3. 数据分页获取，变量unset,分页量参考评估时间调整
4. 数据获取排序规则明确（方便中断后排查执行的id）
5. 脚本重跑机制，防止意外断开后重新执行。可考虑在redis中报错上次处理的id，下次运行从此id继续
6. 数据库连接定时重连机制
7. mysql可考虑批量insert
8. DB操作不要太频繁，中途可适当sleep
9. 手工执行，使用后台执行方式，并监控log
10. 数据量大小评估，脚本执行时间评估，执行后数据确认

## 脚本代码
``` php
<?php if (!defined('BASEPATH')) exit('No direct script access allowed');

/**
 * 任务中心初始化老用户任务数据
 * Created by DannyWang
 * wangjue@mia.com
 * 2017/10/24
 */
class Member_task_init extends CI_Controller {
    public function __construct() {
        parent::__construct();
        //设置该页面执行时间
        set_time_limit(3600 * 24);
        ini_set('memory_limit', '3000M');

        $this->load->library('monolog_client');
        $this->config->load("redisconfig");

        $this->db_read = $this->load->database('read', true);
        $this->db_write = $this->load->database('task_center_write', true);
    }

    /**
     * 完善宝宝信息任务
     * @return bool
     */
    public function initBabyInfoTask() {
        $this->logInfo("====== begin initBabyInfoTask. ======");
        $page_size = 500;
        $page = 1;
        $count = 0;

        // 连接redis 获取上次处理的id
        $redisConf = $this->config->item("redis");
        $this->load->library('redisclient', $redisConf['task_center'][0], 'taskRedisBaby');
        $redis = $this->taskRedisBaby->getInstance('initBabyInfoTask');
        if (!$redis || !$redis->isConnected()) {
            $this->logInfo("redis conn error");
            return false;
        }
        $last_id_key = 'task_init_baby_last_id';
        $last_id = $redis->get($last_id_key);
        $last_user_id = 0;
        if (!empty($last_id)) {
            $last_user_id = $last_id;
        }

        // 循环获取所有数据
        while (true) {
            if ($count % 10 == 0) {
                $this->db_write->reconnect();
                $this->db_read->reconnect();
                $this->logInfo("reconnect");
                sleep(1);
            }

            $sql = "select id from users where id>{$last_user_id} and is_test=0 and user_type=1 and 
                (nickname is not null or child_nickname is not null
                or  child_birth_day<>'0000-00-00' or child_sex<>0
                or user_status<>0 ) limit {$page_size} offset " . ($page - 1) * $page_size;

            $this->logInfo("get sql:{$sql}");
            $res = $this->db_read->query($sql)->result_array();
            if (empty($res)) {
                $this->logInfo("get data empty");
                break;
            }
            foreach ($res as $item) {
                $user_id = $item['id'];
                $task_id = 2;
                $processed_reward_name = '+10蜜豆';
                $finished_time = date('Y-m-d');
                $this->logInfo("begin insert task log.user_id:{$user_id}");
                $result = $this->insertFinalTaskLog($user_id, $task_id, $processed_reward_name, $finished_time);
                $this->logInfo("insertFinalTaskLog result:{$result}");
                $redis->set($last_id_key, $user_id);
            }
            $page++;
            $count++;
            unset($res);
        }
        $this->logInfo("====== finish initBabyInfoTask. ======");
    }

    /**
     * 完善地址信息任务
     * @return bool
     */
    public function initAddressInfoTask() {
        $this->logInfo("====== begin initAddressInfoTask. ======");
        $page_size = 500;
        $page = 1;
        $count = 0;

        // 连接redis 获取上次处理的id
        $redisConf = $this->config->item("redis");
        $this->load->library('redisclient', $redisConf['task_center'][0], 'taskRedisAddress');
        $redis = $this->taskRedisAddress->getInstance('initAddressInfoTask');
        if (!$redis || !$redis->isConnected()) {
            $this->logInfo("redis conn error");
            return false;
        }
        $last_id_key = 'task_init_address_last_id';
        $last_id = $redis->get($last_id_key);
        $last_user_id = 0;
        if (!empty($last_id)) {
            $last_user_id = $last_id;
        }

        while (true) {
            if ($count % 10 == 0) {
                $this->db_write->reconnect();
                $this->db_read->reconnect();
                $this->logInfo("reconnect");
            }
            $sql = "SELECT distinct user_id  from user_address 
                    where user_id > {$last_user_id}
                    ORDER BY user_id asc
                    limit {$page_size} offset " . ($page - 1) * $page_size;

            $this->logInfo("get sql:{$sql}");
            $res = $this->db_read->query($sql)->result_array();
            if (empty($res)) {
                $this->logInfo("get data empty");
                break;
            }
            foreach ($res as $item) {
                $user_id = $item['user_id'];
                $task_id = 3;
                $processed_reward_name = '+10蜜豆';
                $finished_time = date('Y-m-d');
                $this->logInfo("begin insert task log.user_id:{$user_id}");
                $result = $this->insertFinalTaskLog($user_id, $task_id, $processed_reward_name, $finished_time);
                $this->logInfo("insertFinalTaskLog result:{$result}");
                $redis->set($last_id_key, $user_id);
            }
            $page++;
            $count++;
            unset($res);
        }
        $this->logInfo("====== finish initAddressInfoTask. ======");
    }

    /**
     * 记录日志
     * @param $info
     */
    private function logInfo($info) {
        if (is_array($info)) {
            $info = json_encode($info);
        }
        $this->monolog_client->info($info, 'task_init_data');
        echo $info . "\r\n<br>";
    }

    /**
     * 插入一次性任务日志表
     * @param $user_id
     * @param $task_id
     * @param $processed_reward_name
     * @param $finished_time
     * @return bool
     */
    private function insertFinalTaskLog($user_id, $task_id, $processed_reward_name, $finished_time) {
        $set_insert_info = array(
            'user_id' => $user_id,
            'task_id' => $task_id,
            'processed_reward_name' => $processed_reward_name,
            'finished_time' => $finished_time,
            'create_time' => date('Y-m-d H:i:s'),
        );
        $insert_res = $this->db_write->set($set_insert_info)->insert('member_task_final_log');
        if ($insert_res) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * 创建下个月的每日任务表
     * 每月25日执行一次
     */
    public function initTaskTableNextMonth() {
        $this->logInfo("============begin initTaskTableNextMonth ============");
        $month_day_count = date('t', strtotime('+1 month'));

        $this->logInfo("month_day_count:$month_day_count");
        for ($i = 1; $i <= $month_day_count; $i++) {
            if ($i < 10) {
                $date_str = date('Ym0', strtotime('+1 month')) . $i;
            } else {
                $date_str = date('Ym', strtotime('+1 month')) . $i;
            }

            $this->logInfo("begin create table:{$date_str}");
            $result = $this->generateTableByDate($date_str);
            $this->logInfo("create result:{$result}");
        }
        $this->logInfo("============finish initTaskTableNextMonth ============");
    }

    /**
     * 创建每日任务表
     * @param $date
     * @return bool
     */
    private function generateTableByDate($date) {
        if (empty($date)) {
            return false;
        }
        $sql = "
        CREATE TABLE `member_task_log_{$date}` (
              `id` int(11) NOT NULL AUTO_INCREMENT,
              `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '完成任务用户id',
              `task_id` int(11) NOT NULL DEFAULT '0' COMMENT '任务id',
              `processed_reward_name` varchar(50) NOT NULL DEFAULT '' COMMENT '已获取的奖励名称（个性化的奖励名称）',
              `finished_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '任务完成时间',
              `create_time` datetime NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '创建时间',
              PRIMARY KEY (`id`),
              KEY `idx_user_id` (`user_id`),
              KEY `idx_finished_time` (`finished_time`)
            ) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET=utf8 COMMENT='用户日常任务完成日志';
        ";
        $result = $this->db_write->query($sql);
        return $result;
    }
}
```